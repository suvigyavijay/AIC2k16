<html>
<head>
  <link rel="stylesheet" type="text/css" href="./css/form.css">
  <script src="https://ajax.googleapis.com/ajax/libs/jquery/2.1.3/jquery.min.js"></script>
</head>
<body>
<div class="form-style-5">
<form>
<fieldset>
<legend><span class="number">1</span> Name of the Project</legend>
<textarea id="project-name" required="" class="materialize-textarea"></textarea>     
</fieldset>
<fieldset>
<legend><span class="number">2</span> Team Leader</legend>
<input id="tl-name" name="field2" required="" type="text"  placeholder="Name">
<input id="tl-phone" required="" type="text" name="field2" placeholder="Phone">
<input id="tl-email" required="" type="text" name="field2" placeholder="Email">
<!-- <label for="name">Name</label> -->
<div class="pull-right add-member"><i class="fa fa-plus"></i>&nbsp;&nbsp;Add Member</div> 
<div class="members-wrapper">
                
</div>
</fieldset>
<fieldset>
<legend><span class="number">3</span> College</legend>
<input type="radio" name="college" checked>BITS Pilani
<input type="radio" name="college" onclick="other_college()">Other
<input id="college" value="" requied="" type="text" style="display:none" value="BITS Pilani">

</fieldset>
<fieldset>
<legend><span class="number">3</span> Problem</legend>
<select id="category" required="" class="browser-default">
              <option value="" disabled="" selected="">...</option>
                  
              <option value="Schneider Electric">Schneider Electric</option>
                  
              <option value="Luminous">Luminous</option>
                  
              <option value="Sterling Engineering">Sterling Engineering</option>
                  
              <option value="Wooplr">Wooplr</option>
                  
              <option value="HarVa">HarVa</option>
                  
              <option value="Bentley">Bentley</option>
                  
              <option value="Techture">Techture</option>

            </select>
</fieldset>
<fieldset>
<legend><span class="number">4</span> Upload Abstract</legend>
<span>File</span>
<input id="abstract-file" required="" type="file" value="File">
<input class="file-path validate" type="text">
</fieldset>
<input type="submit" value="Register"  class="waves-effect red darken-3 btn submit-button"/>
</form>
</div>
<script type="text/javascript">
// FORM VALIDATION
    var members = 0;

    $(".add-member").click(function() {
        if(members < 3) {
            members++;

            var context = '<div class="mem-'+members+'-wrapper"><div class="col-xs-12 form-subhead">Member '+members+'<div class="pull-right"><i id="mem-'+members+'-delete" value="'+members+'" class="fa fa-times member-delete"></i></div></div><div class="input-field col-sm-6"><input id="mem-'+members+'-name" required type="text" placeholder="Name">\n</div><div class="input-field col-sm-6"><input id="mem-'+members+'-phone" required type="text" placeholder="Phone" >\n</div><div class="input-field col-sm-12"><input id="mem-'+members+'-email" required type="text" placeholder="Email" >\n</div></div>';

            $(".members-wrapper").append(context);

            $("#mem-"+members+"-delete").click(function() {
                var value = $(this).attr("value");
                if(members == value) {
                    $(".mem-"+value+"-wrapper").remove();
                    members--;
                }
                else 
                    alert("Delete members from the bottom of the list !");
            });

            if(members == 3) {
                $(".add-member").hide();
            }
        }

    });


    var abstract;

    $("input#abstract-file").on('change', function(e) {
        abstract = e.target.files;
    });
 

    $("form#project-abstract-form").submit(function(e) {
        e.preventDefault();
        if(validate_project_submit() == 0) {
            $(".error-box").hide();
            $(".submit-button").hide();

            var dat = collect_data();

            $.ajax({
                url: 'projects/status/',
                type: 'POST',
                data: dat,
                cache: false,
                headers : {
                    "X-CSRFToken" : getCookie('csrftoken')
                },
                dataType: 'html',
                processData: false,
                contentType: false,

                success: function(data)
                {
                    $(".body-box").html(data)
                }
            });
        }
        else {

        }
    });

    function other_college() {
        $('#college').show();
        $('#college').getAttribute("value")= "";
    }

    function collect_data() {
        var data = new FormData() ;
        data.append('project-name', $("textarea#project-name").val());
        data.append('tl-name', $("input#tl-name").val());
        data.append('tl-phone', $("input#tl-phone").val());
        data.append('tl-email', $("input#tl-email").val());
        
        for(var z=1;z<=members;z++) {
            data.append('mem-'+z+'-name', $("input#mem-"+z+"-name").val());
            data.append('mem-'+z+'-phone', $("input#mem-"+z+"-phone").val());
            data.append('mem-'+z+'-email', $("input#mem-"+z+"-email").val());
        }
        
        data.append('college', $("input#college").val());
        data.append('category', $("select#category").val());
        //data.append('association', $("select#association").val());

        $.each(abstract, function(key, value)
        {
            data.append(key, value);
        });

        return data;
    }



    function validate_project_submit() {
        var count = 0;
        var errorText = "Following are the errors cited in the form. Please correct them before submitting... <br>";

        // Check for email...
        var re_email = /^([\w-]+(?:\.[\w-]+)*)@((?:[\w-]+\.)*\w[\w-]{0,66})\.([a-z]{2,6}(?:\.[a-z]{2})?)$/i;
        var en_email1 = $("input#tl-email").val();
        if(!(re_email.test(en_email1))) {
            errorText += "<br>&bull;&nbsp;&nbsp;Team Leader's Email is invalid."
            count++;
        }
        for(var i=1;i<=members;i++) {
            if($("input#mem-"+i+"-email").val() != "") {
                var tmp_email = $("input#mem-"+i+"-email").val();
                if(!(re_email.test(tmp_email))) {
                    errorText += "<br>&bull;&nbsp;&nbsp;Member "+i+"'s Email is invalid."
                    count++;
                }
            }    
        }
        
        // Check for phone...
        var re_phone = /^([0-9]{10})$/i;
        var en_phone1 = $("input#tl-phone").val();
        if(!(re_phone.test(en_phone1))) {
            errorText += "<br>&bull;&nbsp;&nbsp;Team Leaders's Phone no is invalid. Please enter a valid 10 digit mobile number."
            count++;
        }
        for(var i=1;i<=members;i++) {
            if($("input#mem-"+i+"-phone").val() != "") {
                var tmp_phone = $("input#mem-"+i+"-phone").val();
                if(!(re_phone.test(tmp_phone))) {
                    errorText += "<br>&bull;&nbsp;&nbsp;Member "+i+"'s Phone no is invalid. Please enter a valid 10 digit mobile number."
                    count++;
                }
            }    
        }

        //format check 
        var file = $("input#abstract-file").val();
        var extn = file.substring(file.lastIndexOf(".")+1);
        if(extn != "pdf" && extn != "PDF" ) {
            errorText += "<br>&bull;&nbsp;&nbsp;The abstract file can only be of PDF Format."
            count++;
        }

        //category check 
        if($("select#category").val() == null) {
            errorText += "<br>&bull;&nbsp;&nbsp;Select a Category."
            count++;
        }
        /*
        //assoc check 
        if($("select#association").val() == null) {
            errorText += "<br>&bull;&nbsp;&nbsp;Select an Association."
            count++;
        }
        */

        $(".error-box").html(errorText).fadeIn(400);

        return count;
    }

</script>

</body>
</html>